{% extends 'main/header.html' %}
{% load static %}


{% block nav %}
<script src="http://code.jquery.com/jquery-latest.min.js"></script>
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=a940651331fabaff83a25f635f19530f&libraries=services"></script>   <!-- kakao map API key -->

<style>
  .map_data_wrap {
    margin: auto;
    width: 95%;
    text-align: left;
    border: 2px solid gray;
    border-radius: 15pt;
    background-color: rgba(197, 197, 197, 0.4);
    padding: 15pt;
  }
  .map_data_line {
    display: flex;
    align-items: center;
    margin: 10px 0;
  }
  .map_data_title { /* ê°€ê²Œì´ë¦„ ìª½ */
    width: 35px;
    color: gray;
    margin-left: 8px;
  }
  .place_name {
    font-size: 17pt;
    font-weight: bold;
  }
  .map_data_content {
    width: 100%;
  }

</style>


<div class="nav">
  <div class="nav_content">
      <div id="map">
          {# map ì§€ë„ ë„£ìŒ #}
          <img src="https://cdn.dribbble.com/users/255281/screenshots/2850148/loading_animation_selectroot.gif" width="100%">
      </div>
      <div class="map_data_wrap">
        <div class="map_detail"></div>
      </div>
  </div>
</div>

<script>
  // nav function
  $(function(){
    let title = $(".title").text()
    // map í¬ë¡¤ë§ í•´ì˜¤ê¸°(selenium)
    $.ajax({
      url: "{% url 'map_load' %}", 
      type: "GET", 
      data: {"title" : title }, 
      success: function(map_data){
        console.log("map", map_data.name, map_data.addr, map_data.tel, map_data.util)
        if(map_data.name == "" && map_data.addr == ""){ // 
            $(".map_detail").html("ê²€ìƒ‰ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.")
            $("#map").html('<img src="https://cdn.icon-icons.com/icons2/1369/PNG/512/-error-outline_90275.png" style="width: 100%; height: 100%;">')
        } else{
            let map_html = ""
            li = [
              '<div class="map_data_content place_name">'+map_data.name+'</div>', 
              '<div class="map_data_content">'+map_data.addr+'</div>', 
              '<div class="map_data_content">'+map_data.tel+'</div>', 
              '<div class="map_data_content">'+map_data.util+'</div>'
            ]
            map_data_name = [
              '<i class="bi bi-shop-window"></i>',   // ê°€ê²Œì´ë¦„
              '<i class="bi bi-geo-alt"></i>',  // ê°€ê²Œì£¼ì†Œ
              '<i class="bi bi-telephone"></i>',  // ì „í™”ë²ˆí˜¸
              '<i class="bi bi-star"></i>'    // í¸ì˜ì‹œì„¤
              ]
            //forë¬¸ ë°–ìœ¼ë¡œ ë‹¤ êº¼ë‚´ì•¼ ê°ê° css ì ìš©ê°€ëŠ¥í•¨
            for ( let i = 0; i < 4; i++)
                if (li[i] == '<div class="map_data_content"></div>'){
                    map_html += '<div class="map_data_line"><div class="map_data_title">'+map_data_name[i]+'</div><div class="map_data_content">ì •ë³´ì—†ìŒ</div></div>'
                    $(".map_detail").html(map_html)
                } else {
                    map_html += '<div class="map_data_line"><div class="map_data_title">'+map_data_name[i]+'</div>'+li[i]+'</div>'
                    $(".map_detail").html(map_html)
                }
            title=title.replace(/"/g,"")
            kakaomapMarkAll(map_data.name,title)
        }
    },
    error: function(){
    console.log("error ë°œìƒì…ë‹ˆë‹¤.")
    }
    })
  })
  </script>
{% endblock nav %}

{% block section %}
<script src="http://code.jquery.com/jquery-latest.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.6.0/font/bootstrap-icons.css">

<!--ê²Œì‹œë¬¼ ì°½-->
<div class="de_all_list">
  <div class="icon">
    {% if user.username == list.user_name %}
    <i class="bi bi-pen-fill" style="color: gray;" onclick="location.href='{% url 'b_modify' list.id %}'" ></i>
    <i class="bi bi-trash" style="color: gray;" onclick="location.href='{% url 'b_delete' list.id %}'"></i>
    {% endif %}
    <i class="bi bi-x-circle" onclick="location.href = document.referrer"></i>      {# document.referrer : ë’¤ë¡œê°€ê¸°+ìƒˆë¡œê³ ì¹¨ #}
  </div>
  <div class="user">
    <b class="b_writerData">
      {% if list.user_id.profile == "" %}
        <img class="profileImg" src="/static/image/DONOTDELETE_DY/profile.jpg">
      {% else %}
        <img class="profileImg" src="/static/image/{{list.user_id.profile}}">
      {% endif %}
      {{list.user_name}}
    </b>
  </div>
  <img class="list_img" src="{% url 'download' list.file_name %}"><br>

  <div>
    <span class="heart_hit_num">
      <span id="likes_heart" onclick="setHeart('{{list.id}}','{{user.username}}')">
        {% if user in list.likes.all %}
        â¤ï¸
        {% else %}
        ğŸ–¤
        {% endif %}
      </span>
      <b class="likes_cnt">{{list.likes.count}}</b>&nbsp;
      <span id="modal_likesList">
        <input type="button" class="likes_modal" value="â–½" onclick="modal_btn()" style="margin-right: 5px;">
        <span id="modal">
          {# ëª¨ë‹¬ì°½ #}
        </span>
      </span>  
      <i class="bi bi-eye-fill"></i> <b style="margin-right: 5px">{{list.hit}}</b>
    <i class="bi bi-chat-right-text-fill"></i> 
    <span class="reply_cnt">{{reply_cnt}}</span>
    </span>
    <span class="day">
      <i class="bi bi-calendar2-check"></i>
      {{list.save_date| date:'Y-m-d'}}
    </span>
  </div>
  <br><br>
  <div class="b_listText">    
    <div>
      <span id="likes_users"></span>  
    </div>
    <b class="title">{{list.title}}</b>
    <div class="content">{{list.content|linebreaksbr}}</div>
  </div>
</div>

<br>

<!--ëŒ“ê¸€ ì°½-->
<div class="re_ply">
  <textarea id="user_reply" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
  <button type="button" class="btn btn-primary" onclick="reply_add()">ë‹µê¸€</button>
  <p></p>
  <div id="reply">
    {# ëŒ“ê¸€ ë‚´ìš© ajax #}
  </div>
  <div class="reply_moreBtn">
    <input type="button" value="ë”ë³´ê¸°" onclick="reply_more()">
  </div>
</div>



<script>
  //ì¢‹ì•„ìš” list ëª¨ë‹¬ì°½
  function modal_btn(){
    console.log($(".likes_modal").val())
    if($(".likes_modal").val() == "â–½"){
      console.log("ifë¬¸ ì…ì¥")
      $(".likes_modal").attr("value", "â–³")
      $("#modal").css("display", "block")
    }else{
      console.log("elseë¬¸ ì…ì¥")
      $(".likes_modal").attr("value", "â–½")
      $("#modal").css("display", "none")

    }
  }

  //ì¢‹ì•„ìš” list ê°€ì ¸ì˜¤ê¸°
  $(function(){
    //console.log('{{list.id}}')  // string 11
    //console.log({{list.id}})  // number 11
    $.ajax({
      url : "{% url 'b_like' %}",
      type : "get",
      data : {"num": {{list.id}}},    // errorë¼ê³  ìƒê°í•˜ì§€ë§Œ ì•„ë‹˜
      headers : {'X-CSRFToken':csrftoken},
      success : function(dict_likes){
        //console.log("ì¢‹ì•„ìš” ëª©ë¡ ì‹¤í–‰")
        let likesUsersHTML = ""
        for(i=0;i<dict_likes.likes_users.length;i++){
          //console.log("dict_likes.profile[i] : ", dict_likes.profile[i])
          likesUsersHTML += "<img class='madal_profileImg' src='/static/image/"+dict_likes.profile[i]+"''>"
          likesUsersHTML += "&#32;&#32;"+dict_likes.likes_users[i]
          likesUsersHTML += "<br>"
        }
        //console.log("likesUsersHTML : ", likesUsersHTML)
        $("#modal").html(likesUsersHTML)
      }
    })
  })

  //ì¢‹ì•„ìš” ë²„íŠ¼ ëˆ„ë¥´ê¸°
  function setHeart(num, user){
    console.log("user : ", user)
    if(user == ''){
      alert('ë¡œê·¸ì¸ ë¨¼ì € ì§„í–‰í•˜ì„¸ìš”')
      location.href = '/member/login'
      return 
    }
    $.ajax({
      url : "{% url 'b_like' %}",
      type : "put",
      data : {"num": num},
      headers : {'X-CSRFToken':csrftoken} ,
      success : function(dict_likes){
          if(dict_likes.likes == 0 ){
            heart = 'â¤ï¸'
          }else{
            heart = 'ğŸ–¤'
          }
          $("#likes_heart").html(heart)
          $(".likes_cnt").html(dict_likes.likes_cnt)
          //console.log("ì¢‹ì•„ìš” ëª©ë¡ ì‹¤í–‰")
          let likesUsersHTML = ""
          //console.log("ì¢‹ì•„ìš” list ê¸¸ì´ : ", dict_likes.likes_users.length)
          if(dict_likes.likes_users.length == 0){
            likesUsersHTML = "ì¢‹ì•„ìš” ì—†ìŒ"
          }else{
            for(i=0;i<dict_likes.likes_users.length;i++){
              //console.log("profile : ", dict_likes.profile[i])
              likesUsersHTML += "<img class='madal_profileImg' src='/static/image/"+dict_likes.profile[i]+"''>"
              likesUsersHTML += "&#32;&#32;"+dict_likes.likes_users[i]
              likesUsersHTML += "<br>"
            }
          }
          //console.log("likesUsersHTML : ", likesUsersHTML)
          $("#modal").html(likesUsersHTML)
      }
    })
  }

  const csrftoken = Cookies.get('csrftoken');
  // tableì—ì„œ ì „ì²´ ëŒ“ê¸€ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
  var save_date = ""
  let reply_appearance = 5   // í•œë²ˆì— í‘œì‹œí•  ëŒ“ê¸€ ê°¯ìˆ˜
  let reply_appearStart = reply_appearance+1    // ë‘ë²ˆì§¸ë¶€í„° í‘œì‹œë  ì‹œì‘ ëŒ“ê¸€ index 
  let reply_html = "" // ëŒ“ê¸€ í‘œì‹œí•  html
  //function reply_display(oneTime = true){   // í˜ì´ì§€ ë¡œë”©ë ë•Œ í•œë²ˆ ë¶ˆëŸ¬ì˜¤ê³ , ë”ë³´ê¸° ë²„íŠ¼ ëˆ„ë¥´ë©´ ì¶”ê°€ë¡œ ë¶ˆëŸ¬ì˜¤ë„ë¡
  //  if(onTime){
  $.ajax({    // í˜ì´ì§€ ë¡œë”©ë ë•Œ ëŒ“ê¸€ ì¶œë ¥
    url:"{% url 'reply_data' list.id %}",
    type:"GET",
    success: function(reply_all){
      if(reply_all.replyData.length == 0){  // ë“±ë¡ëœ ëŒ“ê¸€ì´ ì—†ì„ ë•Œ
        $("#reply").html("")
        $(".reply_moreBtn").html("ë“±ë¡ëœ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.")
      }else{  // ë“±ë¡ëœ ëŒ“ê¸€ì´ ìˆì„ ë•Œ
        if(reply_all.replyData.length <= reply_appearance){  // ë“±ë¡ëœ ëŒ“ê¸€ 5ê°œ ì´í•˜ì¼ ë•Œ
          reply_appearance = reply_all.replyData.length
          $(".reply_moreBtn").html("ëª¨ë“  ëŒ“ê¸€ì…ë‹ˆë‹¤.")
        }
        for(i=0;i<reply_appearance;i++){

          // ë‚ ì§œ ì´ì˜ê²Œ ë½‘ì•„ì˜¤ê¸°
          let date = new Date(reply_all.replyData[i].save_date)
          //writeDate = date.getFullYear()+"-"+(date.getMonth()+1)+"-"+date.getDate()+"  "+ date.getHours()+'ì‹œ '+ date.getMinutes()+'ë¶„'
          //í˜„ì¬ ì‹œê°„ê³¼ ë¹„êµ
          let now = new Date(reply_all.time)
          reply_year = now.getFullYear() - date.getFullYear() // ë…„ë„ ì°¨
          reply_month = now.getMonth() - date.getMonth() // ê°œì›” ì°¨
          reply_day = now.getDate() - date.getDate() // ì¼ìˆ˜ ì°¨
          reply_hour = now.getHours() - date.getHours() // ì‹œê°„ ì°¨
          reply_minute = now.getMinutes() - date.getMinutes() // ë¶„ ì°¨
          reply_second = now.getSeconds() - date.getSeconds() // ì´ˆ ì°¨

          if(reply_year == 0){
            if(reply_month == 0){
              if(reply_day == 0){
                if(reply_hour == 0){
                  if(reply_minute == 0){
                    writeDate = reply_second+"ì´ˆ ì „"
                  }else{writeDate = reply_minute+"ë¶„ ì „"}
                }else{writeDate = reply_hour+"ì‹œê°„ ì „"}
              }else{writeDate = reply_day +"ì¼ ì „"}
            }else{writeDate = (reply_month)+"ê°œì›” ì „"}
          }else{writeDate = reply_year+"ë…„ ì „"}


          reply_html += "<div class='reply"+reply_all.replyData[i].id+" reply_block' align='left'>"
          if(reply_all.profile[i]==""){
            reply_html += "<img class='reply_profileImg' src='/static/image/DONOTDELETE_DY/profile.jpg'>"
          }else{
            reply_html += "<img class='reply_profileImg' src='/static/image/"+reply_all.profile[i]+"'>"
          }
          reply_html += "<div class='reply_text'>&#32;<b class='reply_title'>"+reply_all.replyData[i].user_id+"</b>"
          reply_html += '<span class="reply_day"><i class="bi bi-clock"></i>&nbsp;'
          reply_html += writeDate
          reply_html += '</span>'
          //ì‚­ì œë²„íŠ¼
          if('{{user.username}}' == reply_all.replyData[i].user_id){
            reply_html += '<a class="reply_btn reply_modifyBtn" onclick="reply_delete('+reply_all.replyData[i].id+')">ì‚­ì œ</a>'
          }else if('{{user.username}}' == "admin"){
            reply_html += '<a class="reply_btn reply_modifyBtn" onclick="reply_delete('+reply_all.replyData[i].id+')">ì‚­ì œ</a>'
          }
          //ìˆ˜ì •ë²„íŠ¼
          if('{{user.username}}' == reply_all.replyData[i].user_id){
            reply_html += '<a class="reply_btn reply_deleteBtn" onclick="reply_modify('+reply_all.replyData[i].id+')">ìˆ˜ì •</a>'
          }else if('{{user.username}}' == "admin"){
            reply_html += '<a class="reply_btn reply_deleteBtn" onclick="reply_modify('+reply_all.replyData[i].id+')">ìˆ˜ì •</a>'
          }
          //
          reply_html += "<br><div class='reply_content'>"+reply_all.replyData[i].content+"</div></div></div>"
        }
        $("#reply").html(reply_html)
      }
    }
  })

  // ëŒ“ê¸€ ë”ë³´ê¸° ë²„íŠ¼ ëˆ„ë¥¼ ë•Œ ëŒ“ê¸€ ì¶œë ¥
  function reply_more(){
    $.ajax({
        url:"{% url 'reply_data' list.id %}",
        type:"GET",
        success: function(reply_all){
          if(reply_appearStart+reply_appearance < reply_all.replyData.length){  // ë” ë³´ì—¬ì¤„ ëŒ“ê¸€ì´ 5ê°œ ì´ìƒì¼ ë•Œ
            reply_end = reply_appearStart+reply_appearance
          }else{  // ë” ë³´ì—¬ì¤„ ëŒ“ê¸€ì´ 5ê°œë¯¸ë§Œ(ë§ˆì§€ë§‰ì¼ë•Œ)
            reply_end = reply_all.replyData.length
            $(".reply_moreBtn").html("ëª¨ë“  ëŒ“ê¸€ì…ë‹ˆë‹¤.")
          }
          for(i=reply_appearStart;i<reply_end;i++){
            // ë‚ ì§œ ì´ì˜ê²Œ ë½‘ì•„ì˜¤ê¸°
            let date = new Date(reply_all.replyData[i].save_date)
            writeDate = date.getFullYear()+"-"+(date.getMonth()+1)+"-"+date.getDate()+"  "+ date.getHours()+'ì‹œ '+ date.getMinutes()+'ë¶„'
            reply_html += "<div class='reply"+reply_all.replyData[i].id+" reply_block' align='left'>"
            if(reply_all.profile[i]==""){
              reply_html += "<img class='reply_profileImg' src='/static/image/DONOTDELETE_DY/profile.jpg'>"
            }else{
              reply_html += "<img class='reply_profileImg' src='/static/image/"+reply_all.profile[i]+"'>"
            }
            reply_html += "<div class='reply_text'>&#32;<b class='reply_title'>"+reply_all.replyData[i].user_id+"</b>"
            reply_html += '<span class="reply_day"><i class="bi bi-clock"></i>&nbsp;'
            reply_html += writeDate
            reply_html += '</span>'
            //ì‚­ì œë²„íŠ¼
            if('{{user.username}}' == reply_all.replyData[i].user_id){
              reply_html += '<a class="reply_btn reply_modifyBtn" onclick="reply_delete('+reply_all.replyData[i].id+')">ì‚­ì œ</a>'
            }else if('{{user.username}}' == "admin"){
              reply_html += '<a class="reply_btn reply_modifyBtn" onclick="reply_delete('+reply_all.replyData[i].id+')">ì‚­ì œ</a>'
            }
            //ìˆ˜ì •ë²„íŠ¼
            if('{{user.username}}' == reply_all.replyData[i].user_id){
              reply_html += '<a class="reply_btn reply_deleteBtn" onclick="reply_modify('+reply_all.replyData[i].id+')">ìˆ˜ì •</a>'
            }else if('{{user.username}}' == "admin"){
              reply_html += '<a class="reply_btn reply_deleteBtn" onclick="reply_modify('+reply_all.replyData[i].id+')">ìˆ˜ì •</a>'
            }
            //
            reply_html += "<br><div class='reply_content'>"+reply_all.replyData[i].content+"</div></div></div>"
          }
          $("#reply").html(reply_html)
          reply_appearStart += reply_appearance
        }
      })
  }

  // ìƒˆë¡œìš´ ëŒ“ê¸€ ë’¤ì— ì¶”ê°€ & tableì— ì €ì¥
  function reply_add() {
    dict_NewReply={}
    dict_NewReply ["write_group"] = "{{list.id}}"
    
    if("{{user.id}}" == "None"){  //ë¡œê·¸ì¸ ì•ˆë˜ì–´ìˆìœ¼ë©´ none-userë¡œ ë³´ëƒ„
      dict_NewReply ["user_id"]     = "non-user"
      dict_NewReply ["write_id"]    = 20
    }else{
      dict_NewReply ["user_id"]     = "{{user.username}}"
      dict_NewReply ["write_id"]    = "{{user.id}}"
    }
    dict_NewReply ["title"]       = "{{list.title}}"
    // ì°¸ê³  url ( https://velog.io/@gsuchoi/JavaScript-replace-%EB%B0%8F-%EC%A0%95%EA%B7%9C%EC%8B%9D )
    dict_NewReply ["content"]     = $("#user_reply").val().replace("\n", "<br>")
    $.ajax({
      url: "{% url 'add_reply' %}",
      type: "POST",
      data: dict_NewReply,
      headers: {'X-CSRFToken': csrftoken},
      success: function (ReplyUser) {
        if(ReplyUser.content == ""){
          alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”")
        }
        else{
          alert("ë‹µê¸€ ë‹¬ë¦¼")
          let date = new Date(ReplyUser.userdate)
          //writeDate = date.getFullYear()+"-"+(date.getMonth()+1)+"-"+date.getDate()+"  "+ date.getHours()+'ì‹œ '+ date.getMinutes()+'ë¶„'
          writeDate = "ë°©ê¸ˆ ì „"
          let replyNew_html = ""
          replyNew_html += "<div align='left'>"
          replyNew_html += "<div class='reply"+ReplyUser.id+" reply_block' align='left'>"
          if(ReplyUser.profile==""){
            replyNew_html += "<img class='reply_profileImg' src='/static/image/DONOTDELETE_DY/profile.jpg'>"
          }else{
            replyNew_html += "<img class='reply_profileImg' src='/static/image/"+ReplyUser.profile+"'>"
          }
          replyNew_html += "<div class='reply_text'>&#32;<b class='reply_title'>"+ReplyUser.user_id+"</b>"
          replyNew_html += '<span class="reply_day"><i class="bi bi-clock"></i>&nbsp;'
          replyNew_html += writeDate
          replyNew_html += '</span>'
          //ì‚­ì œë²„íŠ¼ : ì•ˆë¨. ã… ã… ã… 
          reply_html += '<a class="reply_btn reply_modifyBtn" onclick="reply_delete('+ReplyUser.id+')">ì‚­ì œ</a>'
          //ìˆ˜ì •ë²„íŠ¼ : ì•ˆë¨. ã… ã… ã… 
          reply_html += '<a class="reply_btn reply_deleteBtn" onclick="reply_modify('+ReplyUser.id+')">ìˆ˜ì •</a>'
          //
          replyNew_html += "<br><div class='reply_content'>"+ReplyUser.content+"</div></div></div>"
          
          $("#reply").prepend(replyNew_html)
          $("#user_reply").val("")
          var reply_cnt = parseInt($(".reply_cnt").text())
          console.log(reply_cnt)
          reply_cnt=reply_cnt+1
          console.log(reply_cnt)
          $(".reply_cnt").html(reply_cnt)
        }
      }
    })
  }

  function reply_delete(targetID){    // ì‚­ì œí•  ëŒ“ê¸€ì˜ idê°€ ë“¤ì–´ì˜´
    var reply_query = document.querySelector(".reply"+targetID)
    $.ajax({
      url: "{% url 'b_replyEdit' %}",
      type: "get",
      data: {"targetID" : targetID}, 
      success: function(){
        reply_query.parentNode.removeChild(reply_query)
        var reply_cnt = parseInt($(".reply_cnt").text())
        reply_cnt=reply_cnt-1          
        $(".reply_cnt").html(reply_cnt)
      },error: function(){
        console.log("reply_delete ì—ëŸ¬ë°œìƒ")
      }
    })
  }

  function reply_modify(targetID){    // ìˆ˜ì •í•  ëŒ“ê¸€ì˜ idê°€ ë“¤ì–´ì˜´
    let modify_box = ""
    modify_box += '<div class="reply_modifyAction"><textarea id="user_reply" class="modifyBox" placeholder="ìˆ˜ì •í•  ë‚´ìš© ì…ë ¥"></textarea>'
    modify_box += '<button type="button" class="btn btn-primary" onclick="reply_modifyBtn('+targetID+')">ìˆ˜ì •</button></div>'
    $(".reply"+targetID+" .reply_text").append(modify_box)
  }

  function reply_modifyBtn(targetID){
    let reply_after = $(".reply"+targetID+" .modifyBox").val().replace("\n", "<br>")   // ìˆ˜ì •ë‚´ìš©
    console.log("reply_after : ", reply_after)
    // ë§Œë“¤ì—ˆë˜ ë°•ìŠ¤ ì‚­ì œ
    var modifyBox_query = document.querySelector(".reply_modifyAction")
    modifyBox_query.parentNode.removeChild(modifyBox_query)
    // ìˆ˜ì •ëœ ë‚´ìš© ë„£ê¸°
    $(".reply"+targetID+" .reply_content").html(reply_after)
    $.ajax({
      url: "{% url 'b_replyEdit' %}",
      type: "POST",
      data: {"targetID" : targetID, "newContent": reply_after}, 
      headers: {'X-CSRFToken': csrftoken},
      success: function(){
      },error: function(){
        console.log("reply_delete ì—ëŸ¬ë°œìƒ")
      }
    })
  }

</script>
{% endblock section %}


{% block aside %}
<div class="aside">
  <p style="text-align: left; margin-left: 20px;">
    <b style="font-size: 15pt;">blog ë¦¬ë·°</b>
  </p>
  <div class="blog">
    <img src="https://i.pinimg.com/originals/c4/cb/9a/c4cb9abc7c69713e7e816e6a624ce7f8.gif" width="100%">
    {# blog íƒœê·¸ ë„£ìŒ #}
  </div>
  <div class="blog_footer"></div>
</div>

<script>
  // aside function
  const blog_firstSight = 5  // ì²˜ìŒ í‘œì‹œí•  blog ê°¯ìˆ˜
  const blog_scrollNum = 2  // blog ìŠ¤í¬ë¡¤ ë‚´ë¦´ë•Œ ë§ˆë‹¤ 2ê°œì”© ëœ¨ë„ë¡
  let blog_scrollStart = blog_firstSight + 1
  let blog_html = ""

  // ì²˜ìŒì— í‘œì‹œí•˜ëŠ” ë¸”ë¡œê·¸ë§í¬
  $(function(){
    let title = $(".title").text()
    // blog í¬ë¡¤ë§ í•´ì˜¤ê¸°(ajax, res, soup)
    $.ajax({
      url: "{% url 'blog_search' %}",
      type: "GET",
      data: {"title" : title},
      success: function(blog){
        for(i=0; i<blog_firstSight+1; i++){
          //console.log(blog[i][0], blog[i][1], blog[i][2]) //title, href, src
          blog_html += "<a href='"+blog[i][1]+"' class='blog_href'>"
          blog_html += "<div class='blog_img' style='background-image: url(\""+blog[i][2]+"\");'>"
          blog_html += "<div class='blog_img_opecity'></div></div>"
          blog_html += "<div class='blog_title'>"+blog[i][0]+"</div>"
          blog_html += "</a><br>"
          $(".blog").html(blog_html)
        }
      }
    })
  })
  
  // ìŠ¤í¬ë¡¤ í•˜ë©´ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
  const scroll_criterion = 1
  function blog_YesScroll(){
    const myScreenHeight = screen.height  //ë‚´ ëª¨ë‹ˆí„° í¬ê¸°
    let oneTime = false //í•œë²ˆ ìŠ¤í¬ë¡¤ì— í•œë²ˆë§Œ ë¡œë”©
    document.addEventListener('scroll', blog_Scroll, {passive: true})
    //console.log("oneTime : ", oneTime)
    // ìŠ¤í¬ë¡¤ í•˜ë©´ í‘œì‹œí•  ë¸”ë¡œê·¸ ë§í¬
    function blog_Scroll(){
      const asideContentQuery = document.querySelector(".aside")
      const pageHeight = asideContentQuery.clientHeight //aside í´ë˜ìŠ¤ ì „ì²´ ë†’ì´
      const scrollPosition = pageYOffset  // ë‚´ê°€ ìœ„ì¹˜í•œ í˜ì´ì§€ yì¢Œí‘œ
/*
      console.log("pageHeight : ", pageHeight)
      console.log("myScreenHeight : ", myScreenHeight)
      console.log("pageHeight-myScreenHeight/2 : ", pageHeight-myScreenHeight/scroll_criterion)
      console.log("scrollPosition : ", scrollPosition)
      console.log("==================")
*/
      if(pageHeight-myScreenHeight/scroll_criterion < scrollPosition && !oneTime){
        oneTime = true
        let title = $(".title").text()
        // blog í¬ë¡¤ë§ í•´ì˜¤ê¸°(ajax, res, soup)
        $.ajax({
          url: "{% url 'blog_search' %}",
          type: "GET",
          data: {"title" : title},
          success: function(blog){
            let blog_endMsg = "ë”ë³´ë ¤ë©´ ìŠ¤í¬ë¡¤"
            //console.log("blog_scrollStart : ", blog_scrollStart)
            if(blog_scrollStart+blog_scrollNum < blog.length){
              blog_scrollEnd = blog_scrollStart+blog_scrollNum
              //console.log("----1 if : ", blog_scrollStart+blog_scrollNum, "/", blog.length)
            }else{
              blog_scrollEnd = blog.length
              blog_endMsg = "ë¦¬ë·° ë"
              //console.log("----2 if : ", blog_scrollStart+blog_scrollNum, "/", blog.length)

            }
            for(i=blog_scrollStart; i<blog_scrollEnd; i++){
              //console.log(blog[i][0], blog[i][1], blog[i][2]) //title, href, src
              //console.log("===================================", blog_scrollEnd)
              blog_html += "<a href='"+blog[i][1]+"' class='blog_href'>"
              blog_html += "<div class='blog_img' style='background-image: url(\""+blog[i][2]+"\");'>"
              blog_html += "<div class='blog_img_opecity'></div></div>"
              blog_html += "<div class='blog_title'>"+i+blog[i][0]+"</div>"
              blog_html += "</a><br>"

            }
            $(".blog").html(blog_html)
            $(".blog_footer").html(blog_endMsg)
/*
            console.log("pageHeight : ", pageHeight)
            console.log("myScreenHeight : ", myScreenHeight)
            console.log("pageHeight-myScreenHeight : ", pageHeight-myScreenHeight)
            console.log("scrollPosition : ", scrollPosition)
            console.log("==================")
*/
            blog_scrollStart += blog_scrollNum
            oneTime = false
            //console.log("====blog_scrollStart : ", blog_scrollStart)
          }
        })
        
        //console.log("======oneTime : ", oneTime)
      }
    }

  }
blog_YesScroll()
</script>

{% endblock aside %}
